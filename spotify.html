<!DOCTYPE html>
<html>
<body>

<h2>Spotify Playlist Fetcher</h2>

<button id="loginBtn">Login with Spotify</button>
<br><br>

<input type="text" id="playlistInput" placeholder="Enter playlist ID or full URL">
<button id="fetchBtn">Fetch Playlist</button>

<pre id="output"></pre>

<script>
/* -------------------- CONFIG -------------------- */
const clientId = "0843377a81674214a2987451b805f396";
const redirectUri = window.location.origin + window.location.pathname;

let accessToken = null;

/* -------------------- UTILITY FUNCTIONS -------------------- */
function generateRandomString(length) {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let result = '';
  for (let i = 0; i < length; i++) {
    result += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return result;
}

async function sha256(plain) {
  const encoder = new TextEncoder();
  const data = encoder.encode(plain);
  return window.crypto.subtle.digest('SHA-256', data);
}

function base64urlencode(buffer) {
  return btoa(String.fromCharCode(...new Uint8Array(buffer)))
    .replace(/\+/g, '-')
    .replace(/\//g, '_')
    .replace(/=+$/, '');
}

/* -------------------- AUTHENTICATION -------------------- */
async function login() {
  const verifier = generateRandomString(64);
  const hashed = await sha256(verifier);
  const challenge = base64urlencode(hashed);

  localStorage.setItem("verifier", verifier);

  const params = new URLSearchParams({
    response_type: "code",
    client_id: clientId,
    redirect_uri: redirectUri,
    code_challenge_method: "S256",
    code_challenge: challenge,
    scope: "playlist-read-private playlist-read-collaborative"
  });

  window.location = "https://accounts.spotify.com/authorize?" + params;
}

async function exchangeCode() {
  const code = new URLSearchParams(window.location.search).get("code");
  if (!code) return;

  console.log("Authorization code received:", code);

  const verifier = localStorage.getItem("verifier");
  if (!verifier) {
    console.error("PKCE verifier not found in localStorage.");
    return;
  }

  const response = await fetch("https://accounts.spotify.com/api/token", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: new URLSearchParams({
      client_id: clientId,
      grant_type: "authorization_code",
      code: code,
      redirect_uri: redirectUri,
      code_verifier: verifier
    })
  });

  const data = await response.json();

  if (data.error) {
    console.error("Error exchanging code for token:", data);
    document.getElementById("output").textContent = JSON.stringify(data, null, 2);
    return;
  }

  accessToken = data.access_token;
  sessionStorage.setItem("spotify_access_token", accessToken);

  console.log("Access token acquired:", accessToken);
  document.getElementById("output").textContent = "Logged in successfully.";

  // Remove code from URL so exchange doesn't run again
  window.history.replaceState({}, document.title, redirectUri);
}

/* -------------------- PLAYLIST FETCHING -------------------- */
function extractPlaylistId(input) {
  // If input is full URL, extract the ID
  const match = input.match(/playlist\/([a-zA-Z0-9]+)/);
  if (match) return match[1];
  return input.trim(); // assume input is just the ID
}

async function getPlaylistTracks(token, playlistId) {
  try {
    const response = await fetch(`https://api.spotify.com/v1/playlists/${playlistId}/tracks`, {
      headers: {
        Authorization: "Bearer " + token
      }
    });

    const data = await response.json();

    if (data.error) {
      console.error("API error:", data);
      document.getElementById("output").textContent = JSON.stringify(data, null, 2);
      return;
    }

    const ids = data.items.map(item => item.track.id);
    console.log("Track IDs:", ids);

    document.getElementById("output").textContent =
      "Track IDs:\n\n" + ids.join("\n");
  } catch (err) {
    console.error("Fetch failed:", err);
    document.getElementById("output").textContent = "Error fetching playlist.";
  }
}

function handleFetch() {
  if (!accessToken) {
    alert("You must login first and wait for token to be acquired.");
    return;
  }

  const input = document.getElementById("playlistInput").value;
  const playlistId = extractPlaylistId(input);

  if (!playlistId) {
    alert("Enter a valid playlist ID or URL.");
    return;
  }

  getPlaylistTracks(accessToken, playlistId);
}

/* -------------------- INIT -------------------- */
document.getElementById("loginBtn").addEventListener("click", login);
document.getElementById("fetchBtn").addEventListener("click", handleFetch);

// Restore token from session storage if page reloads after redirect
const storedToken = sessionStorage.getItem("spotify_access_token");
if (storedToken) accessToken = storedToken;

// Exchange code if redirected from Spotify login
exchangeCode();
</script>

</body>
</html>
